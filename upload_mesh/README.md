# Инструкция по прошивке Meshtastic на ESP32-C3

## Предварительные требования

**Системные требования:**
- ОС Linux (тестировано на Ubuntu/Debian)
- Python 3.6 или новее
- Доступ к USB-порту
- ESP32-C3 устройство, подключенное по USB

**Что вам понадобится:**
- Компьютер с Linux
- USB-кабель для подключения ESP32-C3
- Файлы прошивки в папке `mesh_bin/`:
  - `bootloader.bin`
  - `partitions.bin`
  - `firmware.bin`

## Шаг 1: Установка Python и системных зависимостей

Если Python не установлен, установите его командой:
```bash
sudo apt update
sudo apt install python3 python3-pip python3-venv
```

Проверьте версию Python:
```bash
python3 --version
```
Должна быть версия 3.6 или выше.

## Шаг 2: Настройка виртуального окружения Python

Виртуальное окружение позволяет изолировать зависимости проекта от системного Python. Это предотвращает конфликты и позволяет иметь разные версии пакетов для разных проектов.

### Создание виртуального окружения

Перейдите в папку проекта upload_mesh:
```bash
cd upload_mesh
```

Создайте виртуальное окружение с именем `venv`:
```bash
python3 -m venv venv
```

**Что произошло?** Была создана папка `venv` содержащая изолированную копию Python с собственной папкой для установки пакетов.

### Активация виртуального окружения

После активации все команды `python` и `pip` будут работать в рамках виртуального окружения:
```bash
source venv/bin/activate
```

**Признак активации:** В начале строки приглашения командной строки появится `(venv)`.

### Установка зависимостей

Установите необходимые пакеты из файла `requirements.txt`:
```bash
pip install -r requirements.txt
```

**Что устанавливается:**
- `pyserial` >= 3.5 - для работы с последовательными интерфейсами (USB)
- `esptool == 4.6.2` - официальный инструмент Espressif для прошивки ESP32

### Деактивация виртуального окружения

Когда работа закончена, выйдите из виртуального окружения:
```bash
deactivate
```

## Шаг 3: Подготовка к прошивке

### Найдите порт устройства

Подключите ESP32-C3 к USB-порту. Найдите имя последовательного порта:
```bash
ls /dev/ttyACM* /dev/ttyUSB* 2>/dev/null || echo "Порт не найден"
```

Обычно это `/dev/ttyACM0` или `/dev/ttyUSB0`. Запомните имя порта.

### Проверьте права доступа

Убедитесь что у пользователя есть права на порт:
```bash
sudo usermod -a -G dialout $USER
```
**Внимание:** После выполнения этой команды необходимо перезагрузить систему или войти в систему заново.

### Активация виртуального окружения

Если не активировано, активируйте виртуальное окружение:
```bash
source venv/bin/activate
```

## Шаг 4: Прошивка устройства

### Автоматическая прошивка с flash.py

Скрипт `flash.py` автоматически обнаружит ваш порт и произведет прошивку в три этапа:

```bash
python flash.py
```

или явно указав порт:
```bash
python flash.py /dev/ttyACM0
 python flash.py /dev/ttyUSB0
```

### Ручная прошивка с esptool.py

Если нужен полный контроль, используйте esptool.py напрямую:
```bash
esptool.py --chip esp32c3 --port /dev/ttyACM0 --baud 921600 write_flash -z \
  0x0 mesh_bin/bootloader.bin \
  0x8000 mesh_bin/partitions.bin \
  0x10000 mesh_bin/firmware.bin
```

## Шаг 5: Объяснение разделов памяти ESP32

ESP32 имеет флеш-память (от 4 до 16 МБ), разделенную на логические разделы. Прошивка использует три основных раздела:

### 1. Bootloader (0x0: mesh_bin/bootloader.bin)

**Расположение:** Адрес 0x0000 (начало флеш-памяти)

**Назначение:**
- Первый код, который выполняется при включении устройства
- Инициализирует процессор и проверяет целостность основного firmware
- Если firmware поврежден, может загрузить резервную копию (OTA)
- Выполняет безопасную загрузку основной программы

**Почему отдельно:**
- Защищает устройство от поврежденного firmware
- Позволяет обновлять firmware без риска оставить устройство в "кирпичном" состоянии
- Может выполнять проверки безопасности и восстановление

### 2. Таблица разделов (0x8000: mesh_bin/partitions.bin)

**Расположение:** Адрес 0x8000 (обычно 32 КБ от начала)

**Назначение:**
- Описывает структуру всей флеш-памяти ESP32
- Указывает местоположение и размер каждого раздела:
  - `app0` - основной firmware
  - `app1` - резервный firmware (для OTA обновлений)
  - `nvs` - энергонезависимое хранилище (настройки)
  - `spiffs` - файловая система (конфигурационные файлы)
  - `vfs` - виртуальная файловая система
- Управляет распределением памяти между различными компонентами

**Почему отдельно:**
- Делает систему гибкой - можно менять размер разделов без перекомпиляции
- Позволяет иметь несколько приложений (A/B обновления)
- Защищает настройки и данные от перезаписи при прошивке

### 3. Основная программа (0x10000: mesh_bin/firmware.bin)

**Расположение:** Адрес 0x10000 (обычно 64 КБ от начала)

**Назначение:**
- Основной двоичный файл приложения Meshtastic
- Содержит весь функционал mesh-коммуникаций:
  - Прием и передача LoRa пакетов
  - Управление mesh-сетью
  - Интерфейсы для подключения устройств (USB, Bluetooth, Wi-Fi)
  - Обработка данных и модулей (позиционирование, телеметрия и т.д.)

**Почему отдельно:**
- Позволяет обновлять только логику приложения
- Легко заменить на новую версию firmware
- Сохраняет bootloader и таблицу разделов неизменными

## Шаг 6: Проверка успешной прошивки

После прошивки ESP32 перезагрузится. В терминале должны появиться сообщения вида:
- Reset...
- ESP-ROM messages
- Meshtastic logo или отладочные сообщения

Если используется Serial Monitor или PlatformIO, можно наблюдать загрузку системы.

## Возможные проблемы и решения

### Проблема: "Permission denied" или "No such file or directory"
**Решение:**
- Проверьте права: `sudo usermod -a -G dialout $USER`, перезагрузите систему
- Проверьте имя порта: `ls /dev/ttyACM*`

### Проблема: "esptool not found"
**Решение:**
- Убедитесь что виртуальное окружение активировано: `source venv/bin/activate`
- Проверьте установку: `pip list | grep esptool`

### Проблема: "Chip mismatch" или "Wrong chip"
**Решение:**
- Проверьте что устройство - ESP32-C3, а не другой вариант ESP32
- Попробуйте сбросить устройство (кнопка BOOT + RESET)

### Проблема: "Failed to connect"
**Решение:**
- Проверьте USB-кабель (данные, не зарядка)
- Попробуйте другой USB-порт
- Убедитесь что устройство в режиме загрузки (BOOT при включении)

## Завершение работы

После успешной прошивки деактивируйте виртуальное окружение:
```bash
deactivate
```

Файлы виртуального окружения можно удалить командой `rm -rf venv`, если нужно очистить проект.

## Дополнительная информация

- **Официальная документация esptool:** https://github.com/espressif/esptool
- **Meshtastic документация:** https://meshtastic.org/docs/
- **ESP32 техническая документация:** https://docs.espressif.com/projects/esp-idf/en/latest/esp32c3/

## Дополнительная информация

### Стандартные адреса для ESP32-C3

**Базовые разделы:**
- `0x0` - Bootloader
- `0x8000` - Partition Table (таблица разделов)
- `0x9000` - NVS (Non-Volatile Storage)
- `0x10000` - Основная прошивка (firmware.bin)

**Файловые системы и данные:**
- `0x260000` - Файловая система (SPIFFS/LittleFS) - ~2.5MB
- `0x290000` - OTA-разделы (для обновлений)

### Типичная команда прошивки ESP32-C3 с файловой системой
```bash
esptool.py --chip esp32c3 --port /dev/ttyACM0 --baud 921600 write_flash -z \
  0x0 bootloader.bin \
  0x8000 partitions.bin \
  0x10000 firmware.bin \
  0x260000 spiffs.bin
```

### Сравнение с нашим логом

В нашем логе для C3 были только базовые компоненты:
- `0x0` - bootloader.bin
- `0x8000` - partitions.bin
- `0x10000` - firmware.bin

Файловая система не прошивалась отдельным образом. Однако анализ бинарника firmware.bin показал, что LittleFS (файловая система) включена в прошивку и будет создана в выделенном разделе при первом запуске устройства. Это определяется по наличию строк LittleFS API в бинарнике (команда: `strings firmware.bin | grep -i littlefs`).

Адрес раздела для файловой системы (spiffs) находится на `0x00300000` (3MB от начала флеш-памяти) и занимает `0x00100000` байт (1MB). Анализ проводился просмотром необработанных данных partitions.bin через hexdump.

**OTA (Over-The-Air) обновления:**
Конфигурация поддерживает OTA обновления с двумя разделами приложений:
- **Два раздела приложений**: ota_0 (основной, 2.25MB) на `0x00100000` и ota_1 (резервный, 640KB) на `0x00260000`
- **Отadata раздел**: 4KB на `0x0000e000` для отслеживания активного раздела
- **Принцип работы**: Во время OTA обновления пишется в резервный раздел, а после успешного обновления загрузчик переключается на него. Это обеспечивает безопасные обновления без риска "кирпичного" состояния устройства. Это позволяет Meshtastic устройствам в сети обновлять firmware удаленно через WiFi без физического доступа.

**Условия для OTA обновлений:**
- **WiFi подключение**: Устройство должно иметь активную WiFi связь для скачивания firmware
- **HTTP сервер**: Нужен веб-сервер с firmware файлами (bootloader.bin, partitions.bin, firmware.bin)
- **Питание**: Достаточный заряд батареи, поскольку обновление занимает время
- **Доступ администратора**: Команда на обновление через Meshtastic app или admin panel
- **Достаточное место**: Свободное пространство в резервном разделе флеш-памяти

Вот почему в нашем случае для C3 прошивка заняла пространство до адреса 0x00239fff (~2.2MB). Для классического ESP32 часто используется больше пространства из-за включенной файловой системы и OTA разделов.

- **HTTP сервер**: Нужен веб-сервер с firmware файлами (bootloader.bin, partitions.bin, firmware.bin)
- **Питание**: Достаточный заряд батареи, поскольку обновление занимает время
- **Доступ администратора**: Команда на обновление через Meshtastic app или admin panel
- Используйте только официальные исходники Meshtastic
