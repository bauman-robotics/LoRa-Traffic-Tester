# Описание WiFi Manager

## Обзор

WiFiManager - это класс C++, предназначенный для устройств на базе ESP32 для управления подключением к WiFi, отправкой HTTP POST запросов на удаленные серверы и интеграцией с данными пакетов LoRa. Класс предоставляет функциональность для подключения к WiFi сетям, отправки телеметрических данных (информации о пакетах LoRa) на серверы Flask или PHP, а также обработки различных параметров конфигурации через директивы препроцессора.

Основная цель - позволить тестерам трафика LoRa загружать данные пакетов на серверы мониторинга через WiFi, с поддержкой как периодических, так и триггерируемых LoRa POST запросов.

## Основные объекты и методы

### Основной класс: WiFiManager

Класс WiFiManager инкапсулирует всю функциональность, связанную с WiFi и коммуникацией с сервером.

#### Ключевые переменные-члены
- `ssid`, `password`: учетные данные WiFi сети
- `apiKey`, `userId`, `userLocation`: аутентификация и идентификация сервера
- `serverProtocol`, `serverIP`, `serverPort`, `serverPath`: детали подключения к серверу
- `enabled`, `postEnabled`: флаги управления WiFi и функциональностью POST
- `post_on_lora_mm`: флаг режима триггера LoRa против периодического режима
- `httpTaskHandle`, `pingTaskHandle`: дескрипторы задач FreeRTOS
- `postQueue`: очередь для пакетных POST запросов
- `lastHttpResult`: статус последней HTTP операции
- Различные счетчики: `postRequestsSent`, `loraPacketsReceived`

#### Основные методы

##### Управление подключением
- `WiFiManager()`: Конструктор, инициализирует WiFi в режим STA
- `connect()`: Устанавливает подключение к WiFi с логикой повтора и тестированием мощности TX
- `disconnect()`: Отключается от WiFi
- `isConnected()`: Возвращает статус подключения
- `enable(bool)`: Включает/отключает WiFi и запускает/останавливает задачу POST

##### Конфигурация
- `loadSettings()`: Загружает учетные данные WiFi и настройки сервера из значений по умолчанию/директив
- `loadWiFiCredentials()`: Загружает сохраненные учетные данные из LittleFS
- `saveWiFiCredentials()`: Сохраняет учетные данные в LittleFS
- `setWiFiCredentials()`: Обновляет учетные данные WiFi

##### Операции POST
- `doHttpPost()`: Отправляет единичный POST запрос с текущими данными LoRa
- `doHttpPostFromData()`: Отправляет POST с предоставленной строкой данных
- `sendSinglePost()`: Запускает немедленный POST если подключен
- `enablePost(bool)`: Включает/отключает периодические POST
- `setPostOnLora(bool)`: Переключает между периодическим и триггерируемым LoRa режимом

##### Управление задачами
- `startPOSTTask()`: Создает задачу FreeRTOS для операций POST
- `stopPOSTTask()`: Останавливает задачу POST
- `httpPostTask()`: Основной цикл задачи POST (периодический или обработка очереди)
- `startPingTask()`, `stopPingTask()`: Управление задачей пинга сервера
- `pingTask()`: Периодическая задача пинга сервера

##### Управление очередью
- `queuePostRequest()`: Добавляет данные POST в очередь
- `processPostQueue()`: Обрабатывает запросы в очереди
- `sendBatchPost()`: Отправляет несколько запросов пакетно (только Flask)

##### Вспомогательные методы
- `uint32ToHexString()`: Преобразует uint32_t в hex строку
- `getLastSenderIdHex()`, `getLastDestinationIdHex()`: Получает ID отправителя/получателя в hex
- `getNipIoUrl()`: Преобразует IP в URL nip.io для HTTPS
- `setLastLoRaPacketLen()`, `getLastLoRaPacketLen()`: Управляет длиной пакета LoRa

### Структурная схема

```
WiFiManager
├── Уровень подключения
│   ├── Режим WiFi STA
│   ├── Управление учетными данными (LittleFS)
│   └── Логика повтора подключения
├── Уровень коммуникации с сервером
│   ├── HTTP/HTTPS клиент
│   ├── Формат JSON Flask
│   ├── Формат form-encoded PHP
│   └── Обработка ответов
├── Уровень задач (FreeRTOS)
│   ├── Задача POST
│   │   ├── Периодический режим
│   │   └── Режим триггера LoRa
│   ├── Задача Ping
│   └── Обработка очереди
├── Управление данными
│   ├── Очередь POST
│   ├── Интеграция данных LoRa
│   └── Пакетная обработка
└── Уровень конфигурации
    ├── Директивы препроцессора
    ├── Настройки по умолчанию
    └── Конфигурация во время выполнения
```

## Текущие настройки

### Конфигурация WiFi
- **Режим**: STA (Станция)
- **Мощность TX**: Настраивается через директиву `WIFI_TX_POWER` (значение по умолчанию варьируется)
- **Автопереподключение**: Включено в режиме отладки
- **Режим сна**: Отключен в режиме отладки
- **Попытки подключения**: `WIFI_CONNECT_ATTEMPTS` (по умолчанию 20)
- **Интервал подключения**: `WIFI_CONNECT_INTERVAL_MS` (по умолчанию 500мс)

### Конфигурация сервера
- **Протокол**: HTTP/HTTPS на основе директивы `USE_HTTPS`
- **Тип сервера**: Flask (`USE_FLASK_SERVER=1`) или PHP (`USE_FLASK_SERVER=0`)
- **Порты**: 80 (HTTP) или 443 (HTTPS) по умолчанию
- **Проверка сертификата**: Пропускается если `USE_INSECURE_HTTPS=1`
- **Таймаут**: 8 секунд для ответов

### Конфигурация POST
- **Интервал**: `POST_INTERVAL_MS` (по умолчанию 30000мс = 30с)
- **Режим**: Периодический или триггерируемый LoRa на основе `post_on_lora_mm`
- **Формат данных**: JSON (Flask) или form-encoded (PHP)
- **Размер пакета**: `BATCH_SIZE` элементов при включенной пакетной обработке
- **Размер очереди**: `MAX_QUEUE_SIZE` максимум запросов в очереди

### Интеграция LoRa
- **Отслеживание длины пакета**: Через `lastLoRaPacketLen`
- **Интеграция RSSI**: Может использовать RSSI как счетчик "hot" в режиме триггера
- **ID отправителя/получателя**: Преобразуются в hex строки для сервера Flask
- **Длина полезной нагрузки**: Используется как счетчик "cold" в определенных режимах

### Функции отладки
- **Сканирование сети**: Включено с `WIFI_DEBUG_FIXES`
- **Тестирование мощности TX**: `WIFI_AUTO_TX_POWER_TEST` перебирает уровни мощности
- **Определение ширины канала**: Логирует информацию 20МГц/40МГц
- **Команды CURL**: Логируются для тестирования запросов сервера

## Предлагаемые улучшения

### 1. Улучшения безопасности
- **Привязка сертификата**: Вместо пропуска проверки реализовать привязку сертификата для HTTPS подключений
- **Шифрование API ключа**: Шифровать сохраненные API ключи в LittleFS используя криптографическое оборудование ESP32
- **Шифрование подключения**: Обеспечить передачу всех чувствительных данных по HTTPS по умолчанию
- **Ограничение скорости**: Реализовать ограничение скорости на стороне сервера для предотвращения злоупотреблений

### 2. Улучшения надежности
- **Экспоненциальная задержка**: Реализовать экспоненциальную задержку для неудачных подключений и повторов POST
- **Пулинг подключений**: Повторно использовать HTTP подключения для нескольких запросов для снижения overhead
- **Мониторинг здоровья**: Добавить более детальные проверки здоровья помимо простого пинга (например, валидация ответа сервера)
- **Управление питанием**: Реализовать интеллектуальное управление питанием для баланса между подключением и временем работы от батареи

### 3. Оптимизации производительности
- **Асинхронные операции**: Преобразовать блокирующие HTTP операции в полностью асинхронные используя асинхронные библиотеки ESP32
- **Сжатие**: Добавить gzip сжатие для данных POST для снижения использования полосы пропускания
- **Оптимизация пакетов**: Улучшить пакетную обработку с настраиваемыми размерами пакетов на основе условий сети
- **Пул памяти**: Использовать пулы памяти для аллокации данных POST для снижения фрагментации heap

### 4. Управление конфигурацией
- **Динамическая конфигурация**: Позволить обновления конфигурации во время выполнения через команды serial или OTA
- **Валидация конфигурации**: Добавить валидацию для всех параметров конфигурации
- **Резервное копирование/восстановление**: Реализовать функциональность резервного копирования и восстановления конфигурации
- **Управление версиями**: Добавить проверку версий для совместимости конфигурации

### 5. Мониторинг и отладка
- **Комплексное логирование**: Добавить структурированное логирование с уровнями и категориями
- **Сбор метрик**: Собирать детальные метрики (задержка, проценты успеха, размеры очередей) для мониторинга
- **Удаленная отладка**: Реализовать удаленное логирование на сервер для отладки развернутых устройств
- **API статуса**: Добавить HTTP endpoint для запроса статуса устройства и конфигурации

### 6. Улучшения качества кода
- **Обработка ошибок**: Реализовать комплексную обработку ошибок с конкретными кодами ошибок
- **Модульные тесты**: Добавить модульные тесты для критических функций (подключение, отправка POST, управление очередью)
- **Модульный дизайн**: Разделить большие методы на меньшие, тестируемые функции
- **Документация**: Добавить документацию в стиле Doxygen для всех публичных методов

### 7. Улучшения протокола
- **Поддержка WebSocket**: Добавить поддержку WebSocket для потоковой передачи данных в реальном времени
- **Интеграция MQTT**: Рассмотреть MQTT как альтернативу HTTP для лучшей эффективности
- **Protocol Buffers**: Использовать Protocol Buffers вместо JSON для более эффективной сериализации
- **Аутентификация**: Реализовать OAuth2 или JWT для более безопасной аутентификации сервера

### 8. Управление ресурсами
- **Оптимизация памяти**: Снизить использование RAM через лучшее управление строками и пулы памяти
- **Оптимизация задач**: Оптимизировать приоритеты задач FreeRTOS и размеры стека
- **Выравнивание износа flash**: Реализовать выравнивание износа для частых записей LittleFS
- **Оптимизация питания**: Добавить режимы сна и wake-on-LoRa для устройств с батарейным питанием

Эти улучшения повысят безопасность, надежность, производительность и поддерживаемость WiFi менеджера, сохраняя обратную совместимость с существующими конфигурациями.
